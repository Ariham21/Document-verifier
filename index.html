<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Document Verifier</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f4f4;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding-top: 50px;
    }
    .card {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 10px #ccc;
      max-width: 400px;
      width: 90%;
      text-align: center;
    }
    input, button {
      margin: 10px;
      padding: 10px;
      width: 90%;
    }
    #status { margin-top: 15px; font-weight: bold; }
    #main, #docSection { display: none; }
  </style>
</head>
<body>
  <div class="card" id="loginSection">
    <h2>Login / Signup</h2>
    <input type="text" id="username" placeholder="Username (email)" />
    <input type="password" id="password" placeholder="Password" />
    <button onclick="signup()">Sign Up</button>
    <button onclick="login()">Login</button>
    <div id="status"></div>
  </div>

  <div class="card" id="main">
    <h2>Document Verifier</h2>
    <input type="file" id="fileInput" />
    <button onclick="storeDocument()">Save Document</button>
    <button onclick="verifyDocument()">Verify Document</button>
    <button onclick="getMyDocs()">üìÇ My Documents</button>
    <button onclick="logout()">Logout</button>
    <div id="status"></div>
  </div>

  <div class="card" id="docSection">
    <h3>üìÅ Stored Documents</h3>
    <ul id="docList"></ul>
  </div>

  <script>
    const scriptURL = "https://script.google.com/macros/s/AKfycbwymKII5Fo5ngMWzcG9P_2golJGVz-apBc_sLl0E7cr5QAqSaRjgXX6Rd6geP1oYhd4hg/exec";

    let currentUser = null;

    async function signup() {
      const username = getUsername(), password = getPassword();
      const res = await fetch(`${scriptURL}?action=signup&username=${username}&password=${password}`);
      const data = await res.json();
      showStatus(data.status === "success" ? "‚úÖ Signed up! Now login." : "‚ö†Ô∏è Username exists.");
    }

    async function login() {
      const username = getUsername(), password = getPassword();
      const res = await fetch(`${scriptURL}?action=login&username=${username}&password=${password}`);
      const data = await res.json();
      if (data.status === "success") {
        currentUser = username;
        document.getElementById("loginSection").style.display = "none";
        document.getElementById("main").style.display = "block";
      } else {
        showStatus("‚ùå Invalid login.");
      }
    }

    async function storeDocument() {
      const file = getFile();
      if (!file) return alert("Select a file first.");
      const hash = await getHash(file);
      const url = `${scriptURL}?action=store&username=${currentUser}&hash=${hash}&filename=${encodeURIComponent(file.name)}`;
      const res = await fetch(url);
      const data = await res.json();
      showStatus(data.status === "stored" ? "‚úÖ Stored!" : data.status === "exists" ? "‚ö†Ô∏è Already stored." : "‚ùå Error.");
    }

    async function verifyDocument() {
      const file = getFile();
      if (!file) return alert("Select a file first.");
      const hash = await getHash(file);
      const url = `${scriptURL}?action=verify&username=${currentUser}&hash=${hash}`;
      const res = await fetch(url);
      const data = await res.json();
      showStatus(data.status === "exists" ? "‚úÖ Verified!" : "‚ùå Not Found.");
    }

    async function getMyDocs() {
      const res = await fetch(`${scriptURL}?action=getDocs&username=${currentUser}`);
      const data = await res.json();
      const list = document.getElementById("docList");
      list.innerHTML = "";
      data.documents.forEach(doc => {
        const li = document.createElement("li");
        li.textContent = `${doc.filename} ‚Äî ${new Date(doc.timestamp).toLocaleString()}`;
        list.appendChild(li);
      });
      document.getElementById("docSection").style.display = "block";
    }

    function logout() {
      currentUser = null;
      location.reload();
    }

    function getUsername() { return document.getElementById("username").value.trim(); }
    function getPassword() { return document.getElementById("password").value.trim(); }
    function getFile() { return document.getElementById("fileInput").files[0]; }

    function showStatus(msg) {
      document.getElementById("status").innerText = msg;
    }

    async function getHash(file) {
      const buffer = await file.arrayBuffer();
      const hashBuffer = await crypto.subtle.digest("SHA-256", buffer);
      return Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, "0")).join("");
    }
  </script>
</body>
</html>
